# EDA Summary: Lenta Uplift Modeling Dataset

> Источник: BigTarget Hackathon (Лента + Microsoft, лето 2020)
> Задача: бинарная классификация (uplift modeling)
> Treatment: маркетинговая коммуникация (рассылка)
> Target: визит в магазин / покупка (`response_att`)

---

## 1. Размер и структура данных

- **687,029 строк** (клиентов) x **193 признака**
- Типы признаков:
  - Числовые (float64): 191 — метрики покупательского поведения, коэфф. вариации, доли
  - Категориальные (object): 1 — `gender`
  - Целочисленные (int64): 1 — `main_format` (бинарный: 0/1)
- `CardHolder` (customer id) отсутствует в признаках — корректно отделён при загрузке
- Константных признаков (nunique=1): **0**
- Квазиконстантных (одно значение >99%): **0**
- Полных дубликатов строк: **30** — вероятно разные клиенты с одинаковыми признаками (не ошибки данных)

---

## 2. Treatment и Target

### Treatment (group)
- **test** (treatment): 515,892 (75.1%)
- **control**: 171,137 (24.9%)
- Соотношение ~3:1
- Значения: строки `'test'` / `'control'` (не 0/1)

### Target (response_att)
- **Conversion rate**: 10.82%
- Сильный дисбаланс классов: 89.2% негативных, 10.8% позитивных

### Uplift (общий)
- CR(treatment) = 11.01%
- CR(control) = 10.26%
- **Uplift = +0.75 п.п.** — положительный эффект маркетинговой кампании
- Кампания повышает вероятность визита в магазин

---

## 3. Пропущенные значения

- **153 из 193 столбцов** имеют пропуски
- Распределение по категориям:
  - Много (>30%): **60 столбцов** — преимущественно `k_var_*` (коэфф. вариации) и `k_var_count_per_cheque_*`
  - Умеренно (5–30%): **53 столбца**
  - Мало (<5%): **40 столбцов**
- Пропуски группируются по паттернам (одинаковое количество у связанных признаков)
- `gender`: 8,581 пропусков (1.25%)
- **Интерпретация**: пропуски в `k_var_*` — коэффициент вариации не определён при отсутствии покупок за период. Это информативный сигнал (отсутствие активности), а не ошибка данных.

---

## 4. Числовые признаки

### Скошенность
- **156 из 192** числовых признаков сильно скошены (|skewness| > 1)
- Все purchase-related метрики (sale_sum, sale_count, cheque_count) имеют тяжёлые правые хвосты
- 22 признака умеренно скошены (0.5–1)
- 14 признаков симметричны (|s| < 0.5)

### Age
- Диапазон: 0–117 лет, среднее: 44.6, медиана: 44
- Skewness: 0.13 (симметричный)
- Аномалии: age=0 (1 случай), age<14 (330 значений), age>90 (129 значений)
- Распределения в treatment/control практически идентичны

### Ключевые признаки
- `response_sms`: доля откликов на **прошлые** SMS-кампании (непрерывная [0,1], 112 уникальных значений, mean=0.78)
- `response_viber`: доля откликов на **прошлые** Viber-кампании (непрерывная [0,1], 113 уникальных значений, mean=0.27)
- `months_from_register`: число месяцев с момента регистрации
- `food_share_15d/1m`: доля продуктов питания в покупках
- `promo_share_15d`: доля промо-товаров в корзине
- `mean_discount_depth_15d`: средняя глубина скидки
- `children`: число детей (0–9, 97% значений 0–2)

---

## 5. Категориальные признаки

### gender
- Ж: 433,448 (63.1%)
- М: 243,910 (35.5%)
- Не определен: 1,090 (0.16%) — редкая категория <1%
- Пропуски: 8,581 (1.25%)

### main_format
- 0 (суперстор): ~90% клиентов
- 1 (продуктовый): ~10% клиентов

---

## 6. Проверка рандомизации (Balance Check)

> Критический этап для uplift modeling.

### T-test (числовые)
- Статистически значимых различий (p<0.05): **154 из 192**
- Практически значимых (|SMD|>0.1): **только 1**
- Большое число значимых различий объясняется размером выборки (N=687K) — даже микроскопические разницы дают p<0.05

### Chi-squared (категориальные)
- `gender`: p<0.001 — статистически значимо
- `main_format`: p=0.0003 — статистически значимо

### Propensity Score (LightGBM)
- **AUC-ROC = 0.5575 +/- 0.0016** (пограничное значение)
- Главные различающие признаки: `response_viber`, `response_sms`, `months_from_register`
- Дисбаланс `response_sms` между группами: treatment=0.8006, control=0.7261 (diff=0.0745)

### Заключение по рандомизации
Рандомизация **в целом приемлемая**. AUC=0.5575 — пограничное, но близко к 0.5. Практически значимых различий (|SMD|>0.1) всего 1. Основной дисбаланс — в `response_viber`/`response_sms` (отклик на прошлые кампании). Propensity score weighting не обязателен, но стоит учитывать при интерпретации.

---

## 7. Корреляционный анализ

### 7.1 Мультиколлинеарность
- **125 пар** с |corr| > 0.8
- **126 уникальных признаков** вовлечены
- Топ по числу связей: `sale_count_6m_g33`, `sale_sum_6m_g33`, `sale_sum_6m_g32`, `sale_count_6m_g57` (по 5 пар каждый)
- Причина: одна метрика x разные товарные группы x разные временные окна — по дизайну коррелируют
- 164 из 193 признаков — метрики по товарным группам (25 групп: g20–g79)

### 7.2 Корреляция с target
- Все 192 числовых признака значимо коррелируют с target (p<0.05)
- Топ-5 по |point-biserial корреляции|:
  1. `k_var_days_between_visits_15d`: r = 0.2988
  2. `k_var_disc_per_cheque_15d`: r = 0.2888
  3. `k_var_days_between_visits_1m`: r = 0.2837
  4. `k_var_cheque_15d`: r = 0.2730
  5. `stdev_discount_depth_15d`: r = 0.2612
- Conversion rate по gender: М (11.2%) > Ж (10.4%)
- Conversion rate по main_format: продуктовый (14.3%) > суперстор (10.3%)

### 7.3 Effect modifiers (uplift по подгруппам)

**Gender:**
- М: uplift = +0.81 п.п.
- Ж: uplift = +0.74 п.п.
- Не определен: uplift = -2.03 п.п. (маленькая группа, n=1,090)

**Age (монотонный рост uplift с возрастом):**

| Группа | CR(T)  | CR(C)  | Uplift  | N       |
|--------|--------|--------|---------|---------|
| <25    | 12.05% | 11.19% | +0.86   | 59,134  |
| 25-35  | 10.37% | 9.85%  | +0.51   | 157,815 |
| 35-45  | 10.60% | 9.94%  | +0.65   | 157,341 |
| 45-55  | 11.10% | 10.15% | +0.95   | 119,576 |
| 55-65  | 10.78% | 10.04% | +0.74   | 113,696 |
| 65+    | 12.05% | 10.84% | **+1.21** | 67,702 |

**Main_format:**
- Формат 1 (продуктовый): uplift = +0.89 п.п.
- Формат 0 (суперстор): uplift = +0.75 п.п.

**Вывод:** потенциальные effect modifiers — `age` (наиболее выраженный, монотонный рост), `gender`, `response_sms`/`response_viber`, `main_format`. Эти признаки — первоочередные кандидаты для uplift-модели.

---

## 8. Предобработка данных

### 8.1 Пропуски
- `gender`: заполнен категорией `"Unknown"`
- Числовые: заполнены **медианой**
- Для столбцов с >10% пропусков: создано **102 флага `_missing`** (бинарные индикаторы)
- Итог: **0 пропусков**

### 8.2 Кодирование
- `gender` → LabelEncoder: Unknown=0, Ж=1, М=2, Не определен=3
- `main_format`: уже числовой (0/1), оставлен как есть
- OHE не применён — базовые модели tree-based (LightGBM/CatBoost)

### 8.3 Выбросы
- Winsorization (clipping 1–99 перцентиль) для **171 сильно скошенного признака** (|skew| > 1)
- Строки не удалялись — каждый клиент ценен для uplift

### 8.4 Удаление признаков
- Удалено **51 признак** из-за высокой корреляции (|r| > 0.8) — итеративный алгоритм (удаляем признак с наибольшим числом связей)
- Константных/квазиконстантных: 0
- Пост-treatment признаков: 0 (все измерены до кампании, подтверждено по `columns_description.md`)

### 8.5 Масштабирование
- StandardScaler подготовлен (fit) для 140 непрерывных признаков
- Не применён — tree-based модели не требуют масштабирования

---

## 9. Финальный датасет

|                  | Train     | Test      |
|------------------|-----------|-----------|
| Строк            | 480,920   | 206,109   |
| Признаков        | 244       | 244       |
| Treatment rate   | 0.7509    | 0.7509    |
| Conversion rate  | 0.1082    | 0.1082    |
| Uplift           | +0.0075   | +0.0075   |

- Split: stratified по treatment x target (70/30), random_state=42
- Пропорции идентичны в train и test (стратификация корректна)
- 244 признака = 142 исходных + 102 `_missing` флагов

### Файлы
```
data/processed/
  X_train.csv              — признаки train
  X_test.csv               — признаки test
  y_train.csv              — target train
  y_test.csv               — target test
  treatment_train.csv      — treatment train
  treatment_test.csv       — treatment test
  preprocessing_pipeline.pkl — pipeline предобработки
```

---

## 10. Рекомендации для моделирования

1. **Базовые модели**: LightGBM или CatBoost как base learner для uplift (S-learner, T-learner, или X-learner через scikit-uplift)
2. **response_sms/viber**: дисбаланс между treatment/control — учитывать при интерпретации
3. **age**: наиболее выраженный effect modifier (монотонный рост uplift с возрастом) — ожидаем, что модель это уловит
4. **k_var_* features**: высокая корреляция с target (top-5), но роль как effect modifiers требует проверки моделью
5. **_missing флаги**: информативный сигнал (отсутствие активности за период), не удалять
6. **Метрика**: uplift-специфичные метрики (uplift@k, AUUC, Qini curve), а не стандартные AUC/accuracy
